{% extends "base.html" %}
{% block title %}{{ ticker }} — Stock News Digest{% endblock %}
{% block content %}
<div class="mb-6">
    <a href="/{{ username }}" class="text-sm text-indigo-600 hover:underline">&larr; Back to dashboard</a>
</div>

<div class="flex items-center justify-between mb-6">
    <div>
        <h1 class="text-2xl font-bold">{{ ticker }} — {{ name }}</h1>
        {% if last_refresh %}
        <p class="text-sm text-gray-500 mt-1">Last refresh: {{ last_refresh }}</p>
        {% endif %}
    </div>
    <button id="refresh-btn" onclick="refreshTicker('{{ ticker }}')"
        class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition flex items-center gap-2">
        <svg id="refresh-icon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
        </svg>
        <span id="refresh-text">Refresh</span>
    </button>
</div>

<!-- Upcoming Events -->
{% if events %}
<div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6 overflow-hidden">
    <div class="flex items-center justify-between px-4 py-3 border-b border-gray-100">
        <h2 class="text-sm font-semibold text-gray-700 flex items-center gap-2">
            <svg class="w-4 h-4 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
            </svg>
            Upcoming Events
            <span class="bg-indigo-100 text-indigo-700 text-xs font-medium px-2 py-0.5 rounded-full">{{ events|length }}</span>
        </h2>
        <div class="flex items-center gap-3 text-xs text-gray-400">
            <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-emerald-500 inline-block"></span>Ex-Div</span>
            <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-indigo-500 inline-block"></span>Pay</span>
        </div>
    </div>
    <div class="divide-y divide-gray-50">
        {% for ev in events %}
        <div class="flex items-center gap-3 px-4 py-2.5 hover:bg-gray-50 transition cursor-pointer stock-event-row"
             data-title="{{ ev.title }}" data-ticker="{{ ev.ticker }}"
             data-type="{{ ev.event_type }}" data-date="{{ ev.event_date }}"
             data-description="{{ ev.description or '' }}"
             data-metadata="{{ ev.metadata or '' }}">
            <span class="w-2 h-2 rounded-full shrink-0
                {% if ev.event_type == 'dividend_ex' %}bg-emerald-500
                {% elif ev.event_type == 'dividend_pay' %}bg-indigo-500
                {% else %}bg-gray-400{% endif %}"></span>
            <span class="text-xs font-medium text-gray-500 w-24 shrink-0 event-date-local" data-date="{{ ev.event_date }}">{{ ev.event_date }}</span>
            <span class="text-sm text-gray-800 flex-1">{{ ev.title }}</span>
            {% if ev.description %}
            <span class="text-xs text-gray-400 shrink-0">{{ ev.description }}</span>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Event Detail Modal -->
<div id="event-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
    <div class="bg-white rounded-xl shadow-xl max-w-md w-full mx-4 p-6">
        <div class="flex items-start justify-between mb-4">
            <h3 id="modal-title" class="text-lg font-bold text-gray-900"></h3>
            <button onclick="closeEventModal()" class="text-gray-400 hover:text-gray-600 p-1">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        <div class="space-y-3">
            <div>
                <span class="text-xs font-medium text-gray-500 uppercase tracking-wide">Event Type</span>
                <p id="modal-type" class="text-sm text-gray-800"></p>
            </div>
            <div>
                <span class="text-xs font-medium text-gray-500 uppercase tracking-wide">Date</span>
                <p id="modal-date" class="text-sm text-gray-800"></p>
            </div>
            <div>
                <span class="text-xs font-medium text-gray-500 uppercase tracking-wide">Details</span>
                <p id="modal-description" class="text-sm text-gray-800"></p>
            </div>
            <div id="modal-meta-section" class="hidden">
                <span class="text-xs font-medium text-gray-500 uppercase tracking-wide">Additional Info</span>
                <div id="modal-meta" class="text-sm text-gray-700 space-y-1 mt-1"></div>
            </div>
        </div>
    </div>
</div>

<!-- News Articles -->
{% if articles %}
<h2 class="text-sm font-semibold text-gray-700 mb-3">News Articles ({{ articles|length }})</h2>
<div class="space-y-4">
    {% for article in articles %}
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
        <div class="flex items-start justify-between gap-4">
            <div class="flex-1">
                <a href="{{ article.url }}" target="_blank" rel="noopener"
                   class="text-lg font-medium text-indigo-600 hover:underline">
                    {{ article.title }}
                </a>
                <div class="flex items-center gap-2 mt-1 text-sm text-gray-500">
                    <span>{{ article.source }}</span>
                    {% if article.published_at %}
                    <span>&middot;</span>
                    <span class="local-time" data-utc="{{ article.published_at }}">{{ article.published_at[:16] }}</span>
                    {% endif %}
                </div>
            </div>
            {% if article.sentiment %}
            <span class="shrink-0 px-2 py-1 rounded-full text-xs font-medium
                {% if article.sentiment == 'positive' %}bg-green-100 text-green-700
                {% elif article.sentiment == 'negative' %}bg-red-100 text-red-700
                {% else %}bg-gray-100 text-gray-600{% endif %}">
                {{ article.sentiment }}
            </span>
            {% endif %}
        </div>
        {% if article.summary %}
        <p class="mt-2 text-sm text-gray-700 line-clamp-3">{{ article.summary }}</p>
        {% endif %}
        {% if article.sentiment_reasoning %}
        <p class="mt-1 text-xs text-gray-400 italic">{{ article.sentiment_reasoning }}</p>
        {% endif %}
    </div>
    {% endfor %}
</div>
{% else %}
<div class="text-center py-12 text-gray-500">
    <p class="text-lg">No articles in the last 3 days.</p>
    <p class="mt-2">Click Refresh to fetch the latest news.</p>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
async function refreshTicker(ticker) {
    const btn = document.getElementById('refresh-btn');
    const text = document.getElementById('refresh-text');
    const icon = document.getElementById('refresh-icon');
    btn.disabled = true;
    text.textContent = 'Refreshing...';
    icon.classList.add('animate-spin');
    try {
        await fetch('/api/refresh/{{ username }}/' + ticker, { method: 'POST' });
        location.reload();
    } catch (e) {
        text.textContent = 'Error — retry';
        btn.disabled = false;
        icon.classList.remove('animate-spin');
    }
}

// --- Timezone-aware timestamp formatting ---
(function() {
    let tz;
    try { tz = Intl.DateTimeFormat().resolvedOptions().timeZone; } catch(e) {}
    if (!tz) tz = 'America/New_York';

    const fmt = new Intl.DateTimeFormat(undefined, {
        timeZone: tz,
        month: 'short', day: 'numeric',
        hour: 'numeric', minute: '2-digit',
        hour12: true,
    });

    document.querySelectorAll('.local-time').forEach(el => {
        const raw = el.dataset.utc;
        if (!raw) return;
        try {
            const d = new Date(raw.endsWith('Z') || raw.includes('+') ? raw : raw + 'Z');
            if (!isNaN(d)) el.textContent = fmt.format(d);
        } catch(e) {}
    });
})();

// --- Event date formatting ---
(function() {
    const dayFmt = new Intl.DateTimeFormat(undefined, { weekday: 'short', month: 'short', day: 'numeric' });
    document.querySelectorAll('.event-date-local').forEach(function(el) {
        try {
            const d = new Date(el.dataset.date + 'T00:00:00');
            if (!isNaN(d)) el.textContent = dayFmt.format(d);
        } catch(e) {}
    });
})();

// --- Event detail modal ---
const typeLabels = {
    'dividend_ex': 'Ex-Dividend Date',
    'dividend_pay': 'Dividend Payment',
};

function closeEventModal() {
    document.getElementById('event-modal').classList.add('hidden');
}

document.querySelectorAll('.stock-event-row').forEach(function(row) {
    row.addEventListener('click', function() {
        document.getElementById('modal-title').textContent = this.dataset.title;
        document.getElementById('modal-type').textContent = typeLabels[this.dataset.type] || this.dataset.type;
        document.getElementById('modal-date').textContent = this.dataset.date;
        document.getElementById('modal-description').textContent = this.dataset.description || 'No details available';

        const metaSection = document.getElementById('modal-meta-section');
        const metaDiv = document.getElementById('modal-meta');
        metaDiv.innerHTML = '';

        if (this.dataset.metadata) {
            try {
                const meta = JSON.parse(this.dataset.metadata);
                const items = [];
                if (meta.record_date) items.push('<p><strong>Record Date:</strong> ' + meta.record_date + '</p>');
                if (meta.declaration_date) items.push('<p><strong>Declaration Date:</strong> ' + meta.declaration_date + '</p>');
                if (meta.pay_date) items.push('<p><strong>Pay Date:</strong> ' + meta.pay_date + '</p>');
                if (meta.currency) items.push('<p><strong>Currency:</strong> ' + meta.currency + '</p>');
                if (meta.dividend_type) items.push('<p><strong>Type:</strong> ' + meta.dividend_type + '</p>');
                if (items.length) { metaDiv.innerHTML = items.join(''); metaSection.classList.remove('hidden'); }
                else { metaSection.classList.add('hidden'); }
            } catch (e) { metaSection.classList.add('hidden'); }
        } else { metaSection.classList.add('hidden'); }

        document.getElementById('event-modal').classList.remove('hidden');
    });
});

document.addEventListener('keydown', function(e) { if (e.key === 'Escape') closeEventModal(); });
const eventModal = document.getElementById('event-modal');
if (eventModal) eventModal.addEventListener('click', function(e) { if (e.target === this) closeEventModal(); });
</script>
{% endblock %}
