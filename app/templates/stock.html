{% extends "base.html" %}
{% block title %}{{ ticker }} — Stock News Digest{% endblock %}
{% block content %}
<div class="mb-6">
    <a href="/{{ username }}" class="text-sm text-indigo-600 hover:underline">&larr; Back to dashboard</a>
</div>

<div class="flex items-center justify-between mb-6">
    <div>
        <h1 class="text-2xl font-bold">{{ ticker }} — {{ name }}</h1>
        {% if last_refresh %}
        <p class="text-sm text-gray-500 mt-1">Last refresh: {{ last_refresh }}</p>
        {% endif %}
    </div>
    <button id="refresh-btn" onclick="refreshTicker('{{ ticker }}')"
        class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition flex items-center gap-2">
        <svg id="refresh-icon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
        </svg>
        <span id="refresh-text">Refresh</span>
    </button>
</div>

{% if articles %}
<h2 class="text-sm font-semibold text-gray-700 mb-3">News Articles ({{ articles|length }})</h2>
<div class="space-y-4">
    {% for article in articles %}
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
        <div class="flex items-start justify-between gap-4">
            <div class="flex-1">
                <a href="{{ article.url }}" target="_blank" rel="noopener"
                   class="text-lg font-medium text-indigo-600 hover:underline">
                    {{ article.title }}
                </a>
                <div class="flex items-center gap-2 mt-1 text-sm text-gray-500">
                    <span>{{ article.source }}</span>
                    {% if article.published_at %}
                    <span>&middot;</span>
                    <span class="local-time" data-utc="{{ article.published_at }}">{{ article.published_at[:16] }}</span>
                    {% endif %}
                </div>
            </div>
            {% if article.sentiment %}
            <span class="shrink-0 px-2 py-1 rounded-full text-xs font-medium
                {% if article.sentiment == 'positive' %}bg-green-100 text-green-700
                {% elif article.sentiment == 'negative' %}bg-red-100 text-red-700
                {% else %}bg-gray-100 text-gray-600{% endif %}">
                {{ article.sentiment }}
            </span>
            {% endif %}
        </div>
        {% if article.summary %}
        <p class="mt-2 text-sm text-gray-700 line-clamp-3">{{ article.summary }}</p>
        {% endif %}
        {% if article.sentiment_reasoning %}
        <p class="mt-1 text-xs text-gray-400 italic">{{ article.sentiment_reasoning }}</p>
        {% endif %}
    </div>
    {% endfor %}
</div>
{% else %}
<div class="text-center py-12 text-gray-500">
    <p class="text-lg">No articles in the last 3 days.</p>
    <p class="mt-2">Click Refresh to fetch the latest news.</p>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
async function refreshTicker(ticker) {
    const btn = document.getElementById('refresh-btn');
    const text = document.getElementById('refresh-text');
    const icon = document.getElementById('refresh-icon');
    btn.disabled = true;
    text.textContent = 'Refreshing...';
    icon.classList.add('animate-spin');
    try {
        await fetch('/api/refresh/{{ username }}/' + ticker, { method: 'POST' });
        location.reload();
    } catch (e) {
        text.textContent = 'Error — retry';
        btn.disabled = false;
        icon.classList.remove('animate-spin');
    }
}

// --- Timezone-aware timestamp formatting ---
(function() {
    let tz;
    try { tz = Intl.DateTimeFormat().resolvedOptions().timeZone; } catch(e) {}
    if (!tz) tz = 'America/New_York';

    const fmt = new Intl.DateTimeFormat(undefined, {
        timeZone: tz,
        month: 'short', day: 'numeric',
        hour: 'numeric', minute: '2-digit',
        hour12: true,
    });

    document.querySelectorAll('.local-time').forEach(el => {
        const raw = el.dataset.utc;
        if (!raw) return;
        try {
            const d = new Date(raw.endsWith('Z') || raw.includes('+') ? raw : raw + 'Z');
            if (!isNaN(d)) el.textContent = fmt.format(d);
        } catch(e) {}
    });
})();
</script>
{% endblock %}
